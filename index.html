<script>
    const Pi = window.Pi;
    Pi.init({ version: "2.0", sandbox: true });

    async function handlePayment() {
        try {
            // المصادقة لفتح الاتصال
            await Pi.authenticate(['payments'], (paymentId) => {});
            
            // طلب الدفع المباشر
            const payment = await Pi.createPayment({
                amount: 1,
                memo: "Test Step 10",
                metadata: { productId: "item-10" }
            }, {
                onReadyForServerApproval: (paymentId) => {
                    return fetch('/api/index', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentId })
                    });
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    alert("تم النجاح! كود العملية: " + txid);
                },
                onCancel: (paymentId) => { console.log("Cancelled"); },
                onError: (error) => { alert("خطأ: " + error.message); }
            });
        } catch (err) {
            alert("حدث خطأ، تأكد من تحديث الصفحة");
        }
    }

    document.getElementById('pay-button').onclick = handlePayment;
</script>
